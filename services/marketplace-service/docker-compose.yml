version: '3.8'

services:
  # PostgreSQL Database
  marketplace_db:
    image: postgres:15-alpine
    container_name: marketplace_db
    environment:
      POSTGRES_DB: ${DB_NAME:-marketplace_db}
      POSTGRES_USER: ${DB_USER:-marketplace_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-marketplace_pass}
  volumes:
    - marketplace_db_data:/var/lib/postgresql/data
  ports:
    - "5433:5432"
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-markteplace_user}"]
    interval: 10s
    timeout: 5s
    retries: 5
  networks:
    - marketplace_network

# Redis Cache
marketplace_redis:
  image: redis:7-alpine
  container_name: marketplace_redis
  command: redis-server --requirepass ${REDIS_PASSWORD:-marketplace_redis_pass} --databases 16
  volumes:
    - marketplace_redis_data:/data
  ports:
    - "6380:6379"
  healthcheck:
    test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
    interval: 10s
    timeout: 5s
    retries: 5
  networks:
    - marketplace_network

# Marketplace Service Application
marketplace_service:
  build:
    context: .
    dockerfile: Dockerfile
  container_name: marketplace_service
  command: sh -c "python manage.py migrate --noinput && python manage.py collectstatic --noinput && python manage.py runserver 0.0.0.0:8002"
  volumes:
    - .:/app
    - marketplace_static:/app/staticfiles
    - marketplace_media:/app/media
  ports:
    - "8002:8002"
  env_file:
    - .env
  environment:
    - DJANGO_SETTINGS_MODULE=config.settings
    - DB_HOST=marketplace_db
    - REDIS_HOST=marketplace_redis
  depends_on:
    marketplace_db:
      condition: service_healthy
    marketplace_redis:
      condition: service_healthy
  healthcheck:
    test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/health/', timeout=5)"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  networks:
    - marketplace_network

volumes:
  marketplace_db_data:
    driver: local
  marketplace_redis:
    driver: local
  marketplace_static:
    driver: local
  marketplace_media:
    driver: local

networks:
  marketplace_network:
    driver: bridge
  
